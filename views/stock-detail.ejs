<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= stock.name || 'éŠ˜æŸ„' %>ï¼ˆ<%= stock.code || 'ã‚³ãƒ¼ãƒ‰æœªæŒ‡å®š' %>ï¼‰</title>
  <!-- Chart.js ã‚„ãã®ä»–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1"></script>
  <style>
    /* ç°¡å˜ãªã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ï¼‰ */
    #dateControls {
      margin-bottom: 1em;
    }

    #dateControls label {
      margin-right: 0.5em;
    }

    #dateControls input {
      margin-right: 1em;
    }
  </style>
</head>

<body>
  <!-- éŠ˜æŸ„æƒ…å ±ã¨åˆ†æå®Ÿè¡Œãƒœã‚¿ãƒ³ -->
  <h1><%= stock.name || 'éŠ˜æŸ„' %>ï¼ˆ<%= stock.code || 'ã‚³ãƒ¼ãƒ‰æœªæŒ‡å®š' %>ï¼‰</h1>
  <button onclick="runAnalysis('<%= stock.code %>')">ğŸ“Š åˆ†æå®Ÿè¡Œ</button>

  <script>
    function runAnalysis(code) {
      fetch(`/run-python?code=${encodeURIComponent(code)}`)
        .then(res => res.text())
        .then(msg => alert(msg))
        .catch(err => alert("ã‚¨ãƒ©ãƒ¼ï¼š" + err));
    }
  </script>

  <!-- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§è¡¨ç¤ºæœŸé–“ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®æ—¥ä»˜å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div id="dateControls">
    <label for="startDate">é–‹å§‹æ—¥:</label>
    <input type="date" id="startDate" name="startDate">
    <label for="endDate">çµ‚äº†æ—¥:</label>
    <input type="date" id="endDate" name="endDate">
    <button id="updateChartBtn">æ›´æ–°</button>
  </div>

  <!-- ã‚°ãƒ©ãƒ•ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <canvas id="lineChart" width="900" height="300"></canvas>
  <canvas id="rsiChart" width="900" height="200"></canvas>
  <canvas id="quarterChart" width="800" height="400"></canvas>

  <script>
    // ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰ JSON åŒ–ã—ãŸå…¨æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆohlcDataï¼‰ã‚’å–å¾—
    const rawData = <%- JSON.stringify(ohlcData || []) %>;

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã« Chart ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
    let lineChartInstance = null;
    let rsiChartInstance = null;

    // æŒ‡å®šã•ã‚ŒãŸé–‹å§‹æ—¥ã€çµ‚äº†æ—¥ã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
    function filterDataByDate(start, end) {
      const startDate = new Date(start);
      const endDate = new Date(end);
      return rawData.filter(r => {
        const d = new Date(r.date);
        return d >= startDate && d <= endDate;
      });
    }

    // charts ã‚’ä½œæˆãƒ»æ›´æ–°ã™ã‚‹é–¢æ•°
    function createCharts(filteredData) {
      // æ•´å½¢ï¼šå„ç³»åˆ—ã‚’ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåŒ–
      const close = filteredData.map(r => ({
        x: new Date(r.date),
        y: parseFloat(r.close)
      }));
      const ma5 = filteredData.map(r => ({
        x: new Date(r.date),
        y: parseFloat(r.ma5)
      }));
      const ma25 = filteredData.map(r => ({
        x: new Date(r.date),
        y: parseFloat(r.ma25)
      }));
      const bbUpper = filteredData.map(r => ({
        x: new Date(r.date),
        y: parseFloat(r.bb_upper)
      }));
      const bbLower = filteredData.map(r => ({
        x: new Date(r.date),
        y: parseFloat(r.bb_lower)
      }));

      const rsi = filteredData
        .filter(r => r.rsi !== null && r.rsi !== undefined)
        .map(r => ({
          x: new Date(r.date),
          y: Number(r.rsi)
        }));

      // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
      if (lineChartInstance) lineChartInstance.destroy();
      if (rsiChartInstance) rsiChartInstance.destroy();

      // Line Chartï¼ˆãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆï¼‹ç§»å‹•å¹³å‡ã€BBï¼‰ã‚’ç”Ÿæˆ
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      lineChartInstance = new Chart(lineCtx, {
        type: 'line',
        data: {
          datasets: [{
              label: 'Close',
              data: close,
              borderColor: 'black',
              pointRadius: 0
            },
            {
              label: 'MA5',
              data: ma5,
              borderColor: 'blue',
              pointRadius: 0
            },
            {
              label: 'MA25',
              data: ma25,
              borderColor: 'green',
              pointRadius: 0
            },
            {
              label: 'BB Upper',
              data: bbUpper,
              borderColor: 'red',
              borderDash: [5, 5],
              pointRadius: 0
            },
            {
              label: 'BB Lower',
              data: bbLower,
              borderColor: 'red',
              borderDash: [5, 5],
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'day'
              },
              title: {
                display: true,
                text: 'æ—¥ä»˜'
              }
            },
            y: {
              title: {
                display: true,
                text: 'ä¾¡æ ¼'
              }
            }
          }
        }
      });

      // RSI Chart ã‚’ç”Ÿæˆ
      const rsiCtx = document.getElementById('rsiChart').getContext('2d');
      rsiChartInstance = new Chart(rsiCtx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'RSI (14)',
            data: rsi,
            borderColor: '#ff9800',
            pointRadius: 0,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'day'
              },
              title: {
                display: true,
                text: 'æ—¥ä»˜'
              }
            },
            y: {
              title: {
                display: true,
                text: 'RSI'
              },
              min: 0,
              max: 100,
              ticks: {
                stepSize: 20
              }
            }
          },
          plugins: {
            annotation: {
              annotations: {
                overbought: {
                  type: 'line',
                  yMin: 70,
                  yMax: 70,
                  borderColor: 'red',
                  borderDash: [5, 5],
                  label: {
                    enabled: true,
                    content: 'è²·ã‚ã‚Œéã'
                  }
                },
                oversold: {
                  type: 'line',
                  yMin: 30,
                  yMax: 30,
                  borderColor: 'green',
                  borderDash: [5, 5],
                  label: {
                    enabled: true,
                    content: 'å£²ã‚‰ã‚Œéã'
                  }
                }
              }
            }
          }
        }
      });
    }

    // åˆæœŸè¡¨ç¤ºç”¨ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éå»30æ—¥é–“
    const today = new Date().toISOString().split('T')[0];
    const threemonthAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000)
      .toISOString().split('T')[0];
    document.getElementById('startDate').value = threemonthAgo;
    document.getElementById('endDate').value = today;

    // åˆæœŸãƒãƒ£ãƒ¼ãƒˆæç”»
    const initialFilteredData = filterDataByDate(threemonthAgo, today);
    createCharts(initialFilteredData);

    // æ—¥ä»˜å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®æ›´æ–°ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«ãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»
    document.getElementById('updateChartBtn').addEventListener('click', () => {
      const startVal = document.getElementById('startDate').value;
      const endVal = document.getElementById('endDate').value;
      const filteredData = filterDataByDate(startVal, endVal);
      createCharts(filteredData);
    });

    // EJS ã§æŒ¿å…¥ã•ã‚ŒãŸï¼”å››åŠæœŸåˆ†ã®æ•°å€¤
    const rev = [
      <%= stock.rev_q1 !== null ? stock.rev_q1 : null %>,
      <%= stock.rev_q2 !== null ? stock.rev_q2 : null %>,
      <%= stock.rev_q3 !== null ? stock.rev_q3 : null %>,
      <%= stock.rev_q4 !== null ? stock.rev_q4 : null %>
    ];
    const prev_rev = [
      <%= stock.prev_rev_q1   !== null ? stock.prev_rev_q1   : 'null' %>,
      <%= stock.prev_rev_q2   !== null ? stock.prev_rev_q2   : 'null' %>,
      <%= stock.prev_rev_q3   !== null ? stock.prev_rev_q3   : 'null' %>,
      <%= stock.prev_rev_q4   !== null ? stock.prev_rev_q4   : 'null' %>
    ];

    // ãƒ©ãƒ™ãƒ«ã¯ã€Œç›´è¿‘ã€ã€Œ1æœŸå‰ã€ã€Œ2æœŸå‰ã€ã€Œ3æœŸå‰ã€
    const labels = ['ç›´è¿‘', '1æœŸå‰', '2æœŸå‰', '3æœŸå‰'];

    // Chart.js ã§æç”»
    new Chart(document.getElementById('quarterChart'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
            label: 'å½“å¹´å£²ä¸Šé«˜ (Total Revenue)',
            data: rev,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          },
          {
            label: 'å‰å¹´å£²ä¸Šé«˜ (Total Revenue)',
            data: prev_rev,
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            title: {
              display: true,
              text: 'å››åŠæœŸ'
            }
          },
          y: {
            title: {
              display: true,
              text: 'é‡‘é¡'
            },
            beginAtZero: true
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => {
                const v = ctx.parsed.y;
                return v != null ? v.toLocaleString() : 'ãƒ‡ãƒ¼ã‚¿ãªã—';
              }
            }
          }
        }
      }
    });
  </script>
</body>

</html>