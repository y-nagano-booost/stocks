<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <title>Stocks List</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
</head>

<body>
  <div class="container-fluid mt-4">
    <h1>Stocks ä¸€è¦§</h1>
    <form action="/analyze-all" method="POST" onsubmit="showLoading()">
      <button type="submit">å…¨éŠ˜æŸ„ã®åˆ†æã‚’å®Ÿè¡Œ</button>
    </form>
    <form action="/analyze-stale" method="POST" onsubmit="return confirm('æœªæ›´æ–°ãƒ»ä¾¡æ ¼ãªã—ã®éŠ˜æŸ„ã®ã¿ã‚’å†åˆ†æã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')">
      <button type="submit" class="btn btn-warning">å†åˆ†æï¼ˆæœªæ›´æ–°ã®ã¿ï¼‰</button>

    </form>

    <div id="loading" style="display:none;">
      ğŸ”„ å…¨éŠ˜æŸ„ã‚’åˆ†æä¸­ã§ã™â€¦ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚
    </div>

    <script>
      function showLoading() {
        document.getElementById("loading").style.display = "block";
      }
    </script>
    <div class="table-responsive">
      <table id="stockTable" class="table table-striped table-hover">
        <thead class="table-light">
          <tr>
            <th>â˜…</th>
            <th>è³¼å…¥ä¾¡æ ¼</th>
            <th>å£²å´ä¾¡æ ¼</th>
            <th>ä¿æœ‰æ ªæ•°</th>
            <th>33æ¥­ç¨®å</th>
            <th>17æ¥­ç¨®å</th>
            <th>éŠ˜æŸ„å</th>
            <th>ã‚³ãƒ¼ãƒ‰</th>
            <th>RSI</th>
            <th>ä¾¡æ ¼</th>
            <th>ä¾¡æ ¼æ—¥</th>
            <th>æ¥­ç¸¾ä¼¸ã³ç‡</th>
            <th>å‰å›æ¨©åˆ©ç¢ºå®šæœˆ</th>
            <th>é…å½“åˆ©å›ã‚Š</th>
            <th>æ“ä½œ</th>
            <th>æ›´æ–°æ—¥æ™‚</th>
          </tr>
        </thead>
        <tbody>
          <% stocks.forEach(stock=> { %>
          <tr>
            <td>
              <button class="btn btn-sm" data-code="<%= stock.code %>" onclick="toggleFavorite(this)">
                <%= stock.favorite ? 'â˜…' : 'â˜†' %>
              </button>
            </td>
            <td data-order="<%= stock.buy_price %>">
              <input type="number" step="0.01" class="form-control form-control-sm" value="<%= stock.buy_price ?? '' %>" onchange="updateBuyPrice('<%= stock.code %>', this.value)">
            </td>
            <td data-order="<%= stock.sell_price %>">
              <input type="number" step="0.01" class="form-control form-control-sm" value="<%= stock.sell_price ?? '' %>" onchange="updateSellPrice('<%= stock.code %>', this.value)">
            </td>
            <td data-order="<%= stock.shares %>">
              <input type="number" step="100" class="form-control form-control-sm" value="<%= stock.shares ?? '' %>" onchange="updateShares('<%= stock.code %>', this.value)">
            </td>
            <td>
              <%= stock.cat_33_name %>
            </td>
            <td>
              <%= stock.cat_17_name %>
            </td>
            <td>
              <%= stock.name %>
            </td>
            <td>
              <%= stock.code %>
            </td>
            <td data-order="<%= stock.rsi %>">
              <%= stock.rsi %>
            </td>
            <td data-order="<%= stock.price %>">
              <%= stock.price %>
            </td>
            <td><%= stock.price_date %></td>
            <%  const rev = stock.rev_q1 ?? stock.rev_q2;
                const prev = stock.prev_rev_q1;
                const growthRate = (rev - prev) / prev;
                const growthText = (growthRate > 0 ? 'æ¥­+' : 'æ¥­') + (growthRate * 100).toFixed(2);
            %>
            <td data-order="<%= growthRate %>">
              <%= growthText %>
            </td>

            <td>
              <%= (stock.last_div_date ? stock.last_div_date.substring(5, 7) : 'â€”' ) + 'æœˆ' %>
            </td>
            <%  function padDividend(yieldValue) {
                  const fixed = yieldValue.toFixed(3);           // ä¾‹: "9.123"
                  const [intPart, decimalPart] = fixed.split('.'); 
                  const paddedInt = intPart.padStart(3, '0');    // "9" â†’ "09"
                  return `${paddedInt}.${decimalPart}ï¼…`;
                  } %>
            <td>
              <%= stock.dividend_yield != null ? padDividend(stock.dividend_yield) : 'â€”' %>
            </td>

            <td>
              <!-- è©³ç´°ãƒœã‚¿ãƒ³ -->
              <a href="/stocks/<%= stock.id %>" class="btn btn-sm btn-primary">
                è©³ç´°
              </a>
              <!-- åˆ†æå®Ÿè¡Œãƒœã‚¿ãƒ³ -->
              <button class="btn btn-sm btn-success" onclick="runAnalysis('<%= stock.code %>')">
                ğŸ“Š åˆ†æå®Ÿè¡Œ
              </button>
              <a href="https://finance.yahoo.co.jp/quote/<%= stock.code %>" target="_blank" class="btn btn-sm btn-outline-secondary" rel="noopener"> <i class="bi bi-box-arrow-up-right"></i> Yahoo!</a>
            </td>
            <td>
              <%= moment(stock.updatedAt).format('YYYY-MM-DD HH:mm') %>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- runAnalysis é–¢æ•°å®šç¾© -->
  <script>
    function runAnalysis(code) {
      fetch(`/run-python?code=${encodeURIComponent(code)}`)
        .then(res => res.text())
        .then(msg => alert(msg))
        .catch(err => alert("ã‚¨ãƒ©ãƒ¼ï¼š" + err));
    }

    function updateBuyPrice(code, price) {
      fetch('/update-buy-price', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            code,
            price
          })
        })
        .then(res => res.json())
        .then(msg => {
          console.log(msg);
        })
        .catch(err => {
          alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + err);
        });
    }

    function updateSellPrice(code, price) {
      fetch('/update-sell-price', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            code,
            price
          })
        })
        .then(res => res.json())
        .then(msg => {
          console.log(msg);
        })
        .catch(err => {
          alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + err);
        });
    }

    function updateShares(code, price) {
      fetch('/update-shares', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            code,
            price
          })
        })
        .then(res => res.json())
        .then(msg => {
          console.log(msg);
        })
        .catch(err => {
          alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + err);
        });
    }

    function toggleFavorite(button) {
      const code = button.dataset.code;
      const isFavorite = button.textContent === 'â˜…';
      const newFavorite = !isFavorite;

      fetch('/update-favorite', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            code,
            favorite: newFavorite
          })
        })
        .then(res => res.json())
        .then(data => {
          // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
          button.textContent = newFavorite ? 'â˜…' : 'â˜†';

          // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©æ›´æ–°ï¼ˆæ¬¡å›ã®åè»¢å¯¾å¿œï¼‰
          button.onclick = () => toggleFavorite(button);
        })
        .catch(err => alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + err));
    }
  </script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js">
  </script>
  <!-- DataTables Buttons æ‹¡å¼µ -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
  <script>
    $(document).ready(function() {
      $('#stockTable').DataTable({
        stateSave: true, // â† æ¤œç´¢ã‚„ãƒšãƒ¼ã‚¸ä½ç½®ãªã©ã‚’ä¿å­˜
        scrollX: true,
        dom: 'Bfrtip', // â† ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é ˜åŸŸæŒ‡å®š
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json'
        },
        pageLength: 25,
        lengthMenu: [5, 10, 25, 50, 100],
        ordering: true,
        searching: true,
        order: [
          [11, 'desc']
        ],
        columnDefs: [
          // æ“ä½œåˆ—ï¼ˆ5åˆ—ç›®ï¼index4ï¼‰ã¯ã‚½ãƒ¼ãƒˆã•ã›ãªã„
          {
            orderable: false,
            targets: 10
          }
        ],
        buttons: [{
          extend: 'colvis',
          text: 'è¡¨ç¤ºåˆ—ã®é¸æŠ',
          collectionLayout: 'fixed two-column'
        }],
      });
    });
  </script>

</body>

</html>